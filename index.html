<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Admin Panel</title>
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Custom styles for a polished look and feel */
        body { font-family: 'Inter', sans-serif; }
        .sidebar-icon { stroke-width: 1.5; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .nav-link.active { background-color: #374151; color: #facc15; }
        .auth-screen {
            background-image: url('https://images.unsplash.com/photo-1555396273-367ea4eb4db5?q=80&w=1974&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        [data-lucide] { pointer-events: none; }
        .editable-text {
            min-width: 50px; /* Ensure editable fields are visible */
            display: inline-block;
            cursor: text;
            border-bottom: 1px dashed #ccc;
        }

        /* Print-specific styles for the invoice */
        @media print {
            /* Hide everything except the invoice modal when printing */
            body.printing-invoice > *:not(#invoiceModal) { display: none; }
            body.printing-invoice #invoiceModal {
                position: absolute; left: 0; top: 0; width: 100%; height: auto;
                display: block !important; background: white; padding: 0; margin: 0;
                border: none; box-shadow: none;
            }
            body.printing-invoice #invoiceModal > div {
                box-shadow: none; border-radius: 0; width: 100%; max-width: 100%; padding: 0;
            }
             body.printing-invoice .invoice-buttons { display: none; }
             /* Remove dashed border for printing */
             body.printing-invoice .editable-text { border-bottom: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 antialiased">

    <!-- Authentication Screen -->
    <div id="authContainer" class="auth-screen h-screen w-screen flex items-center justify-center">
        <div class="w-full max-w-md bg-black/50 backdrop-blur-lg rounded-2xl shadow-2xl p-8 border border-white/20">
            <h2 class="text-3xl font-bold text-white text-center mb-2">Admin Login</h2>
            <p class="text-gray-300 text-center mb-6">Welcome to your Restaurant Dashboard</p>
            <form id="loginForm" class="space-y-4">
                <input type="email" id="email" placeholder="Email Address" required class="w-full bg-gray-700/50 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none transition">
                <input type="password" id="password" placeholder="Password" required class="w-full bg-gray-700/50 text-white p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-yellow-400 focus:outline-none transition">
                <button type="submit" class="w-full bg-yellow-500 text-gray-900 font-bold p-3 rounded-lg hover:bg-yellow-400 transition-transform transform hover:scale-105">Sign In</button>
            </form>
            <p id="authError" class="text-red-400 text-center mt-4 font-semibold"></p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="appContainer" class="hidden flex h-screen overflow-hidden">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-gray-800 text-white p-6 flex flex-col h-full fixed shadow-2xl">
            <h1 class="text-2xl font-bold mb-8 text-yellow-400" id="restaurantNameSidebar">Admin Panel</h1>
            <nav class="flex flex-col space-y-2 overflow-y-auto" id="mainNav">
                <a href="#dashboard" class="nav-link flex items-center p-3 rounded-lg transition-colors hover:bg-gray-700 active"><i data-lucide="layout-dashboard" class="mr-3 sidebar-icon"></i>Dashboard</a>
                <a href="#orders" class="nav-link flex items-center p-3 rounded-lg transition-colors hover:bg-gray-700"><i data-lucide="shopping-cart" class="mr-3 sidebar-icon"></i>Live Orders</a>
                <a href="#menu" class="nav-link flex items-center p-3 rounded-lg transition-colors hover:bg-gray-700"><i data-lucide="book-open" class="mr-3 sidebar-icon"></i>Menu Mgt.</a>
                <a href="#tables" class="nav-link flex items-center p-3 rounded-lg transition-colors hover:bg-gray-700"><i data-lucide="armchair" class="mr-3 sidebar-icon"></i>Table Mgt.</a>
                <a href="#slideshow" class="nav-link flex items-center p-3 rounded-lg transition-colors hover:bg-gray-700"><i data-lucide="gallery-horizontal" class="mr-3 sidebar-icon"></i>Slideshow</a>
                <a href="#offers" class="nav-link flex items-center p-3 rounded-lg transition-colors hover:bg-gray-700"><i data-lucide="gem" class="mr-3 sidebar-icon"></i>Offers</a>
                <a href="#history" class="nav-link flex items-center p-3 rounded-lg transition-colors hover:bg-gray-700"><i data-lucide="history" class="mr-3 sidebar-icon"></i>Order History</a>
                <a href="#analytics" class="nav-link flex items-center p-3 rounded-lg transition-colors hover:bg-gray-700"><i data-lucide="bar-chart-2" class="mr-3 sidebar-icon"></i>Analytics</a>
                <a href="#reviews" class="nav-link flex items-center p-3 rounded-lg transition-colors hover:bg-gray-700"><i data-lucide="star" class="mr-3 sidebar-icon"></i>Reviews</a>
                <a href="#taxes" class="nav-link flex items-center p-3 rounded-lg transition-colors hover:bg-gray-700"><i data-lucide="percent" class="mr-3 sidebar-icon"></i>Tax Mgt.</a>
                <a href="#promotions" class="nav-link flex items-center p-3 rounded-lg transition-colors hover:bg-gray-700"><i data-lucide="ticket" class="mr-3 sidebar-icon"></i>Promotions</a>
                <a href="#settings" class="nav-link flex items-center p-3 rounded-lg transition-colors hover:bg-gray-700"><i data-lucide="settings" class="mr-3 sidebar-icon"></i>Settings</a>
            </nav>
            <div class="mt-auto pt-4">
                <p id="userEmail" class="text-sm text-gray-400 truncate"></p>
                <button id="logoutBtn" class="w-full text-left flex items-center p-3 rounded-lg hover:bg-red-600/80 mt-2 transition-colors"><i data-lucide="log-out" class="mr-3 sidebar-icon"></i>Logout</button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="ml-64 flex-1 p-8 bg-gray-50 overflow-y-auto">
             <div id="dashboard" class="page">
                 <h2 class="text-4xl font-extrabold mb-6 text-gray-800">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-gray-500 font-semibold">Today's Revenue</h3><p class="text-3xl font-bold text-green-500" id="dailyRevenue">â‚¹0</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-gray-500 font-semibold">Today's Orders</h3><p class="text-3xl font-bold text-blue-500" id="dailyOrders">0</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-gray-500 font-semibold">Avg. Table Turn Time</h3><p class="text-3xl font-bold text-purple-500" id="avgTurnTime">0m 0s</p></div>
                    <div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-gray-500 font-semibold">Pending Orders</h3><p class="text-3xl font-bold text-yellow-500" id="pendingOrders">0</p></div>
                </div>
            </div>
             <div id="orders" class="page hidden"><h2 class="text-4xl font-extrabold mb-6 text-gray-800">Live Orders</h2><div id="liveOrdersContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
             <div id="menu" class="page hidden"><div class="flex justify-between items-center mb-6"><h2 class="text-4xl font-extrabold text-gray-800">Menu Management</h2><button id="addCategoryBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 flex items-center shadow-lg"><i data-lucide="plus-circle" class="mr-2"></i>Add Category</button></div><div id="menuContainer" class="space-y-8"></div></div>
             <div id="tables" class="page hidden"><div class="flex justify-between items-center mb-6"><h2 class="text-4xl font-extrabold text-gray-800">Table Management</h2><button id="addTableBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 flex items-center shadow-lg"><i data-lucide="plus-circle" class="mr-2"></i>Add Table</button></div><div id="tablesContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div></div>
             <div id="slideshow" class="page hidden"><div class="flex justify-between items-center mb-6"><h2 class="text-4xl font-extrabold text-gray-800">Slideshow Management</h2><button id="addSlideshowImageBtn" class="bg-teal-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-teal-700 flex items-center shadow-lg"><i data-lucide="plus-circle" class="mr-2"></i>Add Image</button></div><div id="slideshowContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div></div>
             <div id="offers" class="page hidden"><div class="flex justify-between items-center mb-6"><h2 class="text-4xl font-extrabold text-gray-800">Offer Management</h2><button id="addOfferBtn" class="bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-orange-700 flex items-center shadow-lg"><i data-lucide="plus-circle" class="mr-2"></i>Add Offer</button></div><div id="offersContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
             <div id="history" class="page hidden"><h2 class="text-4xl font-extrabold mb-6 text-gray-800">Order History</h2><div class="bg-white p-6 rounded-xl shadow-md overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-4">Order ID</th><th class="p-4">Table</th><th class="p-4">Total</th><th class="p-4">Payment</th><th class="p-4">Date</th><th class="p-4">Actions</th></tr></thead><tbody id="historyContainer"></tbody></table></div></div>
             <div id="analytics" class="page hidden"><h2 class="text-4xl font-extrabold mb-6 text-gray-800">Analytics & Reports</h2><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-bold mb-4">Menu Item Performance</h3><canvas id="menuPerformanceChart"></canvas></div><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-bold mb-4">Daily Sales (Last 7 Days)</h3><canvas id="dailySalesChart"></canvas></div><div class="bg-white p-6 rounded-xl shadow-md"><h3 class="text-xl font-bold mb-4">Order Summary by Table</h3><canvas id="tableSalesChart"></canvas></div><div class="bg-white p-6 rounded-xl shadow-md col-span-full"><h3 class="text-xl font-bold mb-4">Admin Activity Log</h3><div class="max-h-96 overflow-y-auto"><table class="w-full text-left text-sm"><thead class="bg-gray-50 sticky top-0"><tr><th class="p-3">Time</th><th class="p-3">User</th><th class="p-3">Action</th></tr></thead><tbody id="activityLogContainer" class="divide-y"></tbody></table></div></div></div></div>
             <div id="reviews" class="page hidden"><div class="flex justify-between items-center mb-6"><h2 class="text-4xl font-extrabold text-gray-800">Customer Reviews</h2><a id="replyOnGoogleBtn" href="#" target="_blank" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700">Reply on Google</a></div><div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 rounded-lg mb-6" role="alert"><p class="font-bold">Developer Note:</p><p>This is a placeholder. Real-time Google Reviews integration is complex. The "Reply" button links to the URL you provide in Settings.</p></div></div>
             <div id="taxes" class="page hidden"><div class="flex justify-between items-center mb-6"><h2 class="text-4xl font-extrabold text-gray-800">Tax Management</h2><button id="addTaxBtn" class="bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 flex items-center shadow-lg"><i data-lucide="plus-circle" class="mr-2"></i>Add Tax Rule</button></div><div class="bg-white p-6 rounded-xl shadow-md overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-4">Name</th><th class="p-4">Rate (%)</th><th class="p-4">Enabled</th><th class="p-4">Actions</th></tr></thead><tbody id="taxesContainer"></tbody></table></div></div>
             <div id="promotions" class="page hidden"><div class="flex justify-between items-center mb-6"><h2 class="text-4xl font-extrabold text-gray-800">Promotions</h2><button id="addPromoBtn" class="bg-red-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-red-700 flex items-center shadow-lg"><i data-lucide="plus-circle" class="mr-2"></i>Add Promotion</button></div><div class="bg-white p-6 rounded-xl shadow-md overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-4">Code</th><th class="p-4">Discount (%)</th><th class="p-4">Active</th><th class="p-4">Actions</th></tr></thead><tbody id="promosContainer"></tbody></tbody</div></div>
             <div id="settings" class="page hidden">
                 <h2 class="text-4xl font-extrabold mb-6 text-gray-800">Settings</h2>
                 <div class="bg-white p-8 rounded-xl shadow-md max-w-2xl space-y-6">
                    <div><h3 class="text-xl font-bold mb-2">Basic Info</h3><label for="restaurantName" class="block text-sm font-medium text-gray-700">Restaurant Name</label><input type="text" id="restaurantName" class="mt-1 block w-full p-2 border rounded-md"><label for="restaurantCurrency" class="mt-4 block text-sm font-medium text-gray-700">Currency Symbol</label><input type="text" id="restaurantCurrency" class="mt-1 block w-full p-2 border rounded-md"><label for="welcomeMessage" class="mt-4 block text-sm font-medium text-gray-700">Welcome Message (for customers)</label><textarea id="welcomeMessage" rows="3" class="mt-1 block w-full p-2 border rounded-md"></textarea></div>
                    <div><h3 class="text-xl font-bold mb-2">Invoice & Tax Details</h3><label for="restaurantAddress" class="block text-sm font-medium text-gray-700">Address</label><input type="text" id="restaurantAddress" class="mt-1 block w-full p-2 border rounded-md"><label for="restaurantGST" class="mt-4 block text-sm font-medium text-gray-700">GST/Tax ID</label><input type="text" id="restaurantGST" class="mt-1 block w-full p-2 border rounded-md"></div>
                    <div><h3 class="text-xl font-bold mb-2">Branding</h3><label for="logoUrl" class="block text-sm font-medium text-gray-700">Logo URL</label><input type="text" id="logoUrl" placeholder="https://..." class="mt-1 block w-full p-2 border rounded-md"></div>
                    <div><h3 class="text-xl font-bold mb-2">Integrations</h3><label for="googleBusinessLink" class="block text-sm font-medium text-gray-700">Google Business Profile URL</label><input type="url" id="googleBusinessLink" placeholder="https://g.page/r/..." class="mt-1 block w-full p-2 border rounded-md"></div>
                    <button id="saveSettingsBtn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700">Save All Settings</button>
                 </div>
                 <div class="bg-white p-8 rounded-xl shadow-md max-w-2xl space-y-6 mt-8 border-t-4 border-red-500">
                    <h3 class="text-xl font-bold mb-2 text-red-700">Data Management (Danger Zone)</h3>
                    <p class="text-sm text-gray-600">Permanently delete transactional data. This action cannot be undone.</p>
                     <button id="deleteAllOrdersBtn" class="bg-red-800 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-900">Delete All Order History</button>
                    <div class="border-t pt-4">
                        <h3 class="text-xl font-bold mb-2 text-gray-800">Export Data</h3>
                        <p class="text-sm text-gray-600">Download all order and activity log data as a JSON file.</p>
                        <button id="downloadDataBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 mt-2">Download All Data</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="categoryModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h3 class="text-2xl font-bold mb-4">Add/Edit Category</h3><input type="hidden" id="categoryId"><input type="text" id="categoryNameInput" placeholder="Category Name" class="w-full p-3 border rounded-lg mb-4"><div class="flex justify-end space-x-4"><button class="modal-cancel bg-gray-300 px-6 py-2 rounded-lg">Cancel</button><button id="saveCategoryBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg">Save</button></div></div></div>
    <div id="tableModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h3 class="text-2xl font-bold mb-4">Add/Edit Table</h3><input type="hidden" id="tableId"><input type="text" id="tableNameInput" placeholder="Table Name or Number" class="w-full p-3 border rounded-lg mb-4"><div class="flex justify-end space-x-4"><button class="modal-cancel bg-gray-300 px-6 py-2 rounded-lg">Cancel</button><button id="saveTableBtn" class="bg-green-600 text-white px-6 py-2 rounded-lg">Save</button></div></div></div>
    <div id="qrModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md text-center"><h3 id="qrModalTitle" class="text-2xl font-bold mb-4"></h3><p class="text-sm text-gray-400">Scan for Menu â€¢ No app needed.</p><div id="qrcode" class="flex justify-center my-4"></div><div class="space-x-4"><button id="downloadQRBtn" data-table-name="" class="mt-6 bg-green-600 text-white px-6 py-2 rounded-lg">Download PNG</button><button class="modal-cancel mt-6 bg-gray-300 px-6 py-2 rounded-lg">Close</button></div></div></div>
    <div id="itemModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg"><h3 id="itemModalTitle" class="text-2xl font-bold mb-4"></h3><input type="hidden" id="itemId"><input type="hidden" id="itemCategoryId"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><input type="text" id="itemNameInput" placeholder="Item Name" class="w-full p-3 border rounded-lg md:col-span-2"><textarea id="itemDescInput" placeholder="Description" class="w-full p-3 border rounded-lg md:col-span-2"></textarea><input type="number" id="itemPriceInput" placeholder="Price" class="w-full p-3 border rounded-lg"><input type="file" id="itemImageInput" accept="image/png, image/jpeg, image/webp" class="w-full p-2 border rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"></div><img id="itemImagePreview" src="" class="hidden w-24 h-24 object-cover rounded-lg my-4"><div class="flex justify-end space-x-4 mt-6"><button class="modal-cancel bg-gray-300 px-6 py-2 rounded-lg">Cancel</button><button id="saveItemBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg">Save Item</button></div></div></div>
    <div id="taxModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h3 class="text-2xl font-bold mb-4">Add/Edit Tax</h3><input type="hidden" id="taxId"><input type="text" id="taxNameInput" placeholder="Tax Name (e.g., GST)" class="w-full p-3 border rounded-lg mb-4"><input type="number" id="taxRateInput" placeholder="Rate in %" class="w-full p-3 border rounded-lg mb-4"><div class="flex justify-end space-x-4"><button class="modal-cancel bg-gray-300 px-6 py-2 rounded-lg">Cancel</button><button id="saveTaxBtn" class="bg-purple-600 text-white px-6 py-2 rounded-lg">Save</button></div></div></div>
    <div id="promoModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h3 class="text-2xl font-bold mb-4">Add/Edit Promotion</h3><input type="hidden" id="promoId"><input type="text" id="promoCodeInput" placeholder="Promo Code (e.g., SAVE10)" class="w-full p-3 border rounded-lg mb-4"><input type="number" id="promoDiscountInput" placeholder="Discount in %" class="w-full p-3 border rounded-lg mb-4"><div class="flex justify-end space-x-4"><button class="modal-cancel bg-gray-300 px-6 py-2 rounded-lg">Cancel</button><button id="savePromoBtn" class="bg-red-600 text-white px-6 py-2 rounded-lg">Save</button></div></div></div>
    <div id="slideshowModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h3 class="text-2xl font-bold mb-4">Add Slideshow Image</h3><input type="file" id="slideshowImageInput" accept="image/png, image/jpeg, image/webp" class="w-full p-2 border rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"><div class="flex justify-end space-x-4 mt-6"><button class="modal-cancel bg-gray-300 px-6 py-2 rounded-lg">Cancel</button><button id="saveSlideshowImageBtn" class="bg-teal-600 text-white px-6 py-2 rounded-lg">Upload</button></div></div></div>
    <div id="offerModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg"><h3 id="offerModalTitle" class="text-2xl font-bold mb-4"></h3><input type="hidden" id="offerId"><input type="text" id="offerTitleInput" placeholder="Offer Title" class="w-full p-3 border rounded-lg mb-4"><textarea id="offerDescInput" placeholder="Description" class="w-full p-3 border rounded-lg mb-4"></textarea><input type="file" id="offerImageInput" accept="image/png, image/jpeg, image/webp" class="w-full p-2 border rounded-lg file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100"><img id="offerImagePreview" src="" class="hidden w-24 h-24 object-cover rounded-lg my-4"><div class="flex justify-end space-x-4 mt-6"><button class="modal-cancel bg-gray-300 px-6 py-2 rounded-lg">Cancel</button><button id="saveOfferBtn" class="bg-orange-600 text-white px-6 py-2 rounded-lg">Save Offer</button></div></div></div>
    <div id="invoiceModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl"><div id="invoiceContent" class="p-8 border rounded-lg"></div><div class="flex justify-end space-x-4 mt-6 invoice-buttons"><button class="modal-cancel bg-gray-300 px-6 py-2 rounded-lg">Close</button><button id="downloadPdfBtn" class="bg-green-600 text-white px-6 py-2 rounded-lg flex items-center"><i data-lucide="download" class="mr-2 h-4 w-4"></i>Download PDF</button><button id="printInvoiceBtn" class="bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center"><i data-lucide="printer" class="mr-2 h-4 w-4"></i>Print</button></div></div></div>
    <div id="confirmDeleteModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"><div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md"><h3 class="text-2xl font-bold mb-4 text-red-700">Are you absolutely sure?</h3><p id="confirmDeleteText" class="mb-6"></p><input type="text" id="confirmDeleteInput" placeholder='Type "DELETE" to confirm' class="w-full p-3 border rounded-lg mb-4 hidden"><div class="flex justify-end space-x-4"><button class="modal-cancel bg-gray-300 px-6 py-2 rounded-lg">Cancel</button><button id="confirmDeleteBtn" class="bg-red-600 text-white px-6 py-2 rounded-lg">Yes, Delete</button></div></div></div>
    
    <div id="toast" class="fixed top-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl text-lg font-semibold opacity-0 translate-y-10 transition-all duration-300"></div>

    <script type="module">
        // --- SUPABASE INITIALIZATION ---
        const supabaseUrl = 'https://xuneoezzbcmryywdjean.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh1bmVvZXp6YmNtcnl5d2RqZWFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyMzE4NzIsImV4cCI6MjA3NDgwNzg3Mn0.e7hu6m0eKq8PpI78fMsMHujGF1tIh518n2G1motw788';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let chartInstances = {};
        let restaurantSettings = {};
        // Caches hold ALL data for quick lookups and rendering
        let caches = { categories: [], tables: [], orders: [], offers: [], slideshow: [], taxes: [], promos: [] };
        // Quick lookups for items and tables by ID
        let itemMap = new Map();
        let tableMap = new Map();


        // --- UTILS ---
        const htmlEscape = (str) => {
            if (str === null || str === undefined) return '';
            const s = String(str);
            return s.replace(/[&<>"']/g, (match) => {
                switch (match) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case "'": return '&#39;';
                    default: return match;
                }
            });
        };

        const showToast = (message, isError = false) => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed top-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl text-lg font-semibold opacity-0 translate-y-10 transition-all duration-300 z-[60] ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            toast.classList.remove('opacity-0', 'translate-y-10');
            // CRITICAL FIX: Use setTimeout(0) to ensure the browser registers the UI click BEFORE running the complex logic
            setTimeout(() => toast.classList.add('opacity-0', 'translate-y-10'), 3000);
        };

        const logActivity = async (action) => {
            if (!currentUser) return;
            // Removed redundant log to console
            const { error } = await supabaseClient.from('activity_logs').insert({ admin_email: currentUser.email, action });
            if(error) console.error('Error logging activity:', error.message);
        };
        
        // Debounce utility to limit function calls (e.g., from rapid real-time events)
        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        };
        
        // --- AUTH ---
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const checkSession = async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            currentUser = session?.user || null;
            authContainer.classList.toggle('hidden', !!currentUser);
            appContainer.classList.toggle('hidden', !currentUser);
            if (currentUser) initializeApp();
        };

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            document.getElementById('authError').textContent = error ? error.message : '';
            if (!error) { 
                // Use setTimeout(0) to release the thread before starting initialization
                setTimeout(async () => {
                    await logActivity('Logged in'); 
                    await checkSession();
                }, 0);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await logActivity('Logged out');
            await supabaseClient.auth.signOut();
            await checkSession();
        });

        // --- INIT & DATA FETCHING ---
        async function fetchSettings() {
             if (!currentUser || !currentUser.email) return;

             // 1. Try to fetch by user_email (Recommended, new schema)
             let { data, error } = await supabaseClient.from('settings').select('*').eq('user_email', currentUser.email).maybeSingle();
             
             if (error || !data) {
                // 2. Fallback: Try to fetch the first existing row (Legacy support)
                const { data: fallbackData, error: fallbackError } = await supabaseClient.from('settings').select('*').limit(1).maybeSingle();
                data = fallbackData;
                error = fallbackError;
             }

            if (error) {
                console.error('Error fetching settings (Dual Fallback):', error.message);
                return;
            }
            // Ensure settings has a default structure if null
            restaurantSettings = data || {
                user_email: currentUser.email,
                name: 'Restaurant Admin Panel',
                currency_symbol: 'â‚¹',
                logo_url: '',
                welcome_message: 'Welcome to your digital menu.',
                google_business_url: '#',
                address: '123 Main Street',
                gst_number: 'GSTINXXXXXXXXXXXXX'
            };
        }

        async function fetchData(tableName, cacheKey, options = {}) {
            let query = supabaseClient.from(tableName).select(options.select || '*');
            if (options.order) {
                const [column, direction] = options.order.split(',');
                query = query.order(column, { ascending: direction !== 'desc' });
            }
            const { data, error } = await query;
            if (error) { console.error(`Error fetching ${tableName}:`, error); return; }
            caches[cacheKey] = data || [];
        }

        function createLookups() {
            // Create Item Map
            itemMap.clear();
            caches.categories.forEach(category => {
                (category.items || []).forEach(item => {
                    itemMap.set(item.id, item);
                });
            });

            // Create Table Map
            tableMap.clear();
            caches.tables.forEach(table => {
                tableMap.set(table.id, table);
            });
        }
        
        // Lightweight function for specific page updates
        async function fetchAndRenderData(tableNames) {
            const promises = tableNames.map(name => {
                switch (name) {
                    case 'settings': return fetchSettings();
                    case 'categories': return fetchData('categories', 'categories', { order: 'created_at', select: '*, items (*)' });
                    case 'tables': return fetchData('tables', 'tables', { order: 'name' });
                    case 'orders': return fetchData('orders', 'orders', { order: 'created_at,desc' });
                    case 'taxes': return fetchData('taxes', 'taxes');
                    case 'promotions': return fetchData('promotions', 'promos');
                    case 'slideshow': return fetchData('slideshow_images', 'slideshow', { order: 'created_at' });
                    case 'offers': return fetchData('offers', 'offers', { order: 'created_at' });
                    default: return Promise.resolve();
                }
            });
            await Promise.all(promises);
            createLookups();
        }

        // Heavy-weight function for initial load and menu/promo/slideshow updates
        async function fetchAndRenderAll() {
             await fetchAndRenderData(['settings', 'categories', 'tables', 'orders', 'taxes', 'promotions', 'slideshow', 'offers']);
             renderAll();
        }

        // Optimized function for real-time updates (orders and dependencies)
        const fetchAndRenderLiveUpdates = debounce(async () => {
            // Use setTimeout(0) to defer rendering and ensure UI remains responsive
            setTimeout(async () => {
                await fetchAndRenderData(['settings', 'orders', 'tables', 'taxes']);
                
                // Only render the elements that need real-time updates
                renderSettings();
                renderLiveOrders();
                renderOrderHistory();
                renderTaxes();
                renderAnalytics();
                lucide.createIcons(); // Re-create icons after dynamic content changes
            }, 0);
        }, 100); 


        function renderAll() {
            renderSettings(); renderMenu(); renderTables(); renderLiveOrders(); renderOrderHistory();
            renderTaxes(); renderPromos(); renderSlideshow(); renderOffers(); renderAnalytics();
            lucide.createIcons(); // Ensure all initial icons are rendered
        }

        async function initializeApp() {
            try {
                await fetchAndRenderAll(); // Initial full load
                setupRealtimeListeners();
                setupEventListeners();
            } catch (e) {
                 console.error("Initialization failed:", e);
                 showToast("Failed to start application. Check console.", true);
            }
        }

        // --- REAL-TIME LISTENERS ---
        function setupRealtimeListeners() {
            // Live Orders listener (very fast update)
            supabaseClient.channel('live-updates')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, fetchAndRenderLiveUpdates)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'tables' }, fetchAndRenderLiveUpdates)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'taxes' }, fetchAndRenderLiveUpdates)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'settings' }, fetchAndRenderLiveUpdates)
                .subscribe();

            // Slower updates that require full category/menu reload
            supabaseClient.channel('full-updates')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'categories' }, fetchAndRenderAll)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'items' }, fetchAndRenderAll)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'promotions' }, fetchAndRenderAll)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'slideshow_images' }, fetchAndRenderAll)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'offers' }, fetchAndRenderAll)
                .subscribe();
        }

        // --- UI RENDERING ---
        const renderSettings = () => {
            const s = restaurantSettings;
            document.getElementById('restaurantName').value = s.name || '';
            document.getElementById('restaurantCurrency').value = s.currency_symbol || 'â‚¹';
            document.getElementById('welcomeMessage').value = s.welcome_message || '';
            document.getElementById('logoUrl').value = s.logo_url || '';
            document.getElementById('googleBusinessLink').value = s.google_business_url || '';
            document.getElementById('restaurantAddress').value = s.address || '';
            document.getElementById('restaurantGST').value = s.gst_number || '';
            
            document.getElementById('restaurantNameSidebar').textContent = s.name || 'Admin Panel';
            document.getElementById('replyOnGoogleBtn').href = s.google_business_url || '#';
        };

        const renderMenu = () => {
            document.getElementById('menuContainer').innerHTML = caches.categories.map(category => `
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-bold text-gray-800">${htmlEscape(category.name)}</h3>
                        <div class="space-x-2">
                            <button class="edit-category-btn text-blue-500 hover:text-blue-700 p-2" data-id="${category.id}" data-name="${htmlEscape(category.name)}"><i data-lucide="edit"></i></button>
                            <button class="delete-category-btn text-red-500 hover:text-red-700 p-2" data-id="${category.id}"><i data-lucide="trash-2"></i></button>
                        </div>
                    </div>
                    <div class="space-y-4">
                        ${(category.items || []).map(item => `
                            <div class="flex items-center justify-between border-t pt-4">
                                <div class="flex items-center"><img src="${htmlEscape(item.image_url) || 'https://placehold.co/100x100/FACC15/1F2937?text=Food'}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/FACC15/1F2937?text=Food';" class="w-16 h-16 rounded-lg object-cover mr-4">
                                    <div><p class="font-bold text-lg">${htmlEscape(item.name)} ${!item.is_available ? '<span class="text-xs bg-red-100 text-red-700 p-1 rounded">Unavailable</span>' : ''}</p>
                                        <p class="text-sm text-gray-500">${htmlEscape(item.description) || ''}</p>
                                        <p class="font-semibold text-gray-700">${restaurantSettings.currency_symbol || 'â‚¹'}${item.price}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                     <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" value="" class="sr-only peer item-availability-toggle" data-id="${item.id}" ${item.is_available ? 'checked' : ''}><div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-green-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div></label>
                                    <button class="edit-item-btn p-2 text-gray-600 hover:text-blue-600" data-id="${item.id}"><i data-lucide="edit"></i></button>
                                </div>
                            </div>`).join('') || '<p class="text-gray-400 italic">No items in this category yet.</p>'}
                    </div>
                    <button class="add-item-btn mt-4 w-full border-2 border-dashed border-gray-300 hover:border-blue-500 hover:text-blue-500 text-gray-500 p-3 rounded-lg transition" data-category-id="${category.id}">+ Add New Item</button>
                </div>`).join('');
            lucide.createIcons();
        };

        const renderTables = () => {
             document.getElementById('tablesContainer').innerHTML = caches.tables.map(table => `
                <div class="bg-white p-6 rounded-xl shadow-md text-center">
                    <p class="text-xl font-bold">${htmlEscape(table.name)}</p>
                    <div class="mt-4 space-x-2">
                        <button class="show-qr-btn bg-yellow-400 px-4 py-2 rounded-lg font-semibold" data-id="${table.id}" data-name="${htmlEscape(table.name)}">Show QR</button>
                        <button class="delete-table-btn text-red-500" data-id="${table.id}">Delete</button>
                    </div>
                </div>`).join('');
            lucide.createIcons();
        };

        const renderLiveOrders = () => {
            const liveOrders = caches.orders.filter(o => o.status === 'pending' || o.status === 'preparing');
            const container = document.getElementById('liveOrdersContainer');
            if (liveOrders.length === 0) {
                container.innerHTML = `<p class="text-gray-500 col-span-full">Awaiting new orders...</p>`; return;
            }
            container.innerHTML = liveOrders.map(order => {
                const tableName = tableMap.get(order.table_id)?.name || 'Unknown Table';
                const timeSince = Math.floor((new Date() - new Date(order.created_at)) / 60000);
                let statusBadge = '';
                if (order.status === 'pending') statusBadge = `<span class="text-xs font-semibold bg-red-100 text-red-800 px-2 py-1 rounded-full">New</span>`;
                else if (order.status === 'preparing') statusBadge = `<span class="text-xs font-semibold bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">Preparing</span>`;
                
                // Determine button content based on status
                let buttons = '';
                if (order.status === 'pending') {
                    buttons = `<button class="update-order-status-btn flex-1 bg-yellow-500 text-white p-2 rounded-lg hover:bg-yellow-600 transition" data-id="${order.id}" data-status="preparing">Start Preparing</button>`;
                } else if (order.status === 'preparing') {
                    buttons = `<button class="update-order-status-btn flex-1 bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition" data-id="${order.id}" data-status="completed">Mark as Completed</button>`;
                }
                buttons += `<button class="update-order-status-btn bg-gray-500 text-white p-2 rounded-lg hover:bg-gray-600 transition" data-id="${order.id}" data-status="cancelled">Cancel</button>`;


                return `
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 ${order.status === 'pending' ? 'border-red-500' : 'border-yellow-500'}">
                    <div class="flex justify-between items-center">
                        <h4 class="text-xl font-bold">${htmlEscape(tableName)}</h4>
                        <div class="flex items-center space-x-2">${statusBadge}<span class="text-sm font-semibold bg-gray-200 text-gray-700 px-2 py-1 rounded-full">${timeSince}m ago</span></div>
                    </div>
                    <div class="my-4 space-y-2 border-t border-b py-2">${order.order_details.items.map(i => `<p><span class="font-bold">${i.quantity}x</span> ${htmlEscape(i.name)}</p>`).join('')}</div>
                    <div class="flex space-x-2" id="order-btns-${order.id}">
                        ${buttons}
                    </div>
                </div>`
            }).join('');
            lucide.createIcons();
        };

        const renderOrderHistory = () => {
            const historyOrders = caches.orders.filter(o => o.status === 'completed' || o.status === 'cancelled');
            document.getElementById('historyContainer').innerHTML = historyOrders.map(order => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-mono text-xs">${(tableMap.get(order.table_id)?.name || 'Unknown').replace(' ','-')}-${order.id.substring(0,6)}</td>
                    <td class="p-4">${htmlEscape(tableMap.get(order.table_id)?.name || 'Unknown')}</td>
                    <td class="p-4 font-semibold">${restaurantSettings.currency_symbol || 'â‚¹'}${order.order_details.total.toFixed(2)}</td>
                    <td class="p-4"><span class="px-2 py-1 text-xs rounded-full ${order.payment_status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${order.payment_status}</span></td>
                    <td class="p-4">${new Date(order.created_at).toLocaleString()}</td>
                    <td class="p-4">
                        <button class="generate-invoice-btn text-blue-600 hover:underline" data-order-id="${order.id}">Invoice</button>
                        <button class="delete-order-btn text-red-600 hover:underline ml-2" data-order-id="${order.id}">Delete</button>
                    </td>
                </tr>`).join('');
            lucide.createIcons();
        };
        
        const renderTaxes = () => {
            document.getElementById('taxesContainer').innerHTML = caches.taxes.map(tax => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-medium">${htmlEscape(tax.name)}</td><td class="p-4">${tax.rate_percent}%</td>
                    <td class="p-4"><input type="checkbox" class="tax-enabled-toggle" data-id="${tax.id}" ${tax.is_enabled ? 'checked' : ''}></td>
                    <td class="p-4 space-x-2"><button class="edit-tax-btn text-blue-600 hover:underline" data-id="${tax.id}" data-name="${htmlEscape(tax.name)}" data-rate="${tax.rate_percent}">Edit</button><button class="delete-tax-btn text-red-600 hover:underline" data-id="${tax.id}">Delete</button></td>
                </tr>`).join('');
            lucide.createIcons();
        };

        const renderPromos = () => {
            document.getElementById('promosContainer').innerHTML = caches.promos.map(promo => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-mono bg-gray-100 rounded">${htmlEscape(promo.code)}</td><td class="p-4">${promo.discount_percent}%</td>
                    <td class="p-4"><input type="checkbox" class="promo-active-toggle" data-id="${promo.id}" ${promo.is_active ? 'checked' : ''}></td>
                    <td class="p-4 space-x-2"><button class="edit-promo-btn text-blue-600 hover:underline" data-id="${promo.id}" data-code="${htmlEscape(promo.code)}" data-discount="${promo.discount_percent}">Edit</button><button class="delete-promo-btn text-red-600 hover:underline" data-id="${promo.id}">Delete</button></td>
                </tr>`).join('');
            lucide.createIcons();
        };

        const renderSlideshow = () => {
            document.getElementById('slideshowContainer').innerHTML = caches.slideshow.map(image => `
                <div class="relative group">
                    <img src="${htmlEscape(image.image_url)}" class="w-full h-48 object-cover rounded-lg shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/400x200/CCCCCC/666666?text=Image+Error';">
                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <button class="delete-slideshow-btn text-white p-3 bg-red-600/80 rounded-full hover:bg-red-700 transition" data-id="${image.id}" data-url="${htmlEscape(image.image_url)}"><i data-lucide="trash-2"></i></button>
                    </div>
                </div>`).join('') || '<p>No slideshow images uploaded.</p>';
            lucide.createIcons();
        };

        const renderOffers = () => {
            document.getElementById('offersContainer').innerHTML = caches.offers.map(offer => `
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <img src="${htmlEscape(offer.image_url) || 'https://placehold.co/400x200/FF7F50/FFFFFF?text=Offer'}" class="w-full h-40 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x200/FF7F50/FFFFFF?text=Offer';">
                    <div class="p-4">
                        <div class="flex justify-between items-start">
                            <h4 class="text-lg font-bold">${htmlEscape(offer.title)}</h4>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer offer-active-toggle" data-id="${offer.id}" ${offer.is_active ? 'checked' : ''}><div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div></label>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">${htmlEscape(offer.description) || ''}</p>
                        <div class="text-right mt-4 space-x-2">
                            <button class="edit-offer-btn text-blue-600 font-semibold hover:underline" data-id="${offer.id}">Edit</button>
                            <button class="delete-offer-btn text-red-600 font-semibold hover:underline" data-id="${offer.id}">Delete</button>
                        </div>
                    </div>
                </div>`).join('') || '<p>No offers created yet.</p>';
            lucide.createIcons();
        };

        const renderAnalytics = async () => {
            // Re-render only on updates that impact the dashboard summary
            const today = new Date(); today.setHours(0,0,0,0);
            const todaysOrders = caches.orders.filter(o => new Date(o.created_at) > today && o.status === 'completed');
            const revenue = todaysOrders.reduce((sum, o) => sum + o.order_details.total, 0);
            
            document.getElementById('dailyRevenue').textContent = `${restaurantSettings.currency_symbol || 'â‚¹'}${revenue.toFixed(2)}`;
            document.getElementById('dailyOrders').textContent = todaysOrders.length;
            document.getElementById('pendingOrders').textContent = caches.orders.filter(o => ['pending', 'preparing'].includes(o.status)).length;
            
            // Recalculate turn times
            const turnTimes = todaysOrders.filter(o => o.closed_at).map(o => (new Date(o.closed_at) - new Date(o.created_at)) / 1000);
            const avgTime = turnTimes.length ? turnTimes.reduce((a,b) => a+b, 0) / turnTimes.length : 0;
            const minutes = Math.floor(avgTime / 60); const seconds = Math.floor(avgTime % 60);
            document.getElementById('avgTurnTime').textContent = `${minutes}m ${seconds}s`;

            // Charts data preparation (using all orders for historical charts)
            const itemCounts = {};
            caches.orders.forEach(order => {
                if (order.status === 'completed' && order.order_details && order.order_details.items) { 
                    order.order_details.items.forEach(item => { 
                        itemCounts[htmlEscape(item.name)] = (itemCounts[htmlEscape(item.name)] || 0) + item.quantity; 
                    }); 
                }
            });

            renderChart('menuPerformanceChart', 'bar', {
                labels: Object.keys(itemCounts),
                datasets: [{ label: 'Units Sold', data: Object.values(itemCounts), backgroundColor: 'rgba(54, 162, 235, 0.6)' }]
            }, { indexAxis: 'y' });
            
            // ... (Sales by Day and Sales by Table chart logic remains the same)
            const salesByDay = {};
            for(let i=6; i>=0; i--) { const d = new Date(); d.setDate(d.getDate() - i); salesByDay[d.toLocaleDateString()] = 0; }
            caches.orders.forEach(order => {
                if(order.status === 'completed') { const orderDate = new Date(order.created_at).toLocaleDateString(); if(salesByDay.hasOwnProperty(orderDate)) { salesByDay[orderDate] += order.order_details.total; } }
            });
             renderChart('dailySalesChart', 'line', {
                labels: Object.keys(salesByDay),
                datasets: [{ label: 'Daily Revenue', data: Object.values(salesByDay), borderColor: 'rgba(75, 192, 192, 1)', tension: 0.1 }]
            });

            const salesByTable = {};
            caches.orders.forEach(order => {
                if (order.status === 'completed') { const tableName = tableMap.get(order.table_id)?.name || 'Unknown'; salesByTable[htmlEscape(tableName)] = (salesByTable[htmlEscape(tableName)] || 0) + order.order_details.total; }
            });
            renderChart('tableSalesChart', 'doughnut', {
                labels: Object.keys(salesByTable),
                datasets: [{ label: 'Revenue by Table', data: Object.values(salesByTable), backgroundColor: ['rgba(255, 99, 132, 0.7)','rgba(54, 162, 235, 0.7)','rgba(255, 206, 86, 0.7)','rgba(75, 192, 192, 0.7)'] }]
            });

            const { data, error } = await supabaseClient.from('activity_logs').select('*').order('created_at', { ascending: false }).limit(20);
            if(error) return;
            document.getElementById('activityLogContainer').innerHTML = data.map(log => `
                <tr class="hover:bg-gray-50"><td class="p-3 text-gray-500">${new Date(log.created_at).toLocaleString()}</td><td class="p-3 font-medium">${log.admin_email}</td><td class="p-3">${htmlEscape(log.action)}</td></tr>`).join('');
        };

        function renderChart(canvasId, type, data, options = {}) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            chartInstances[canvasId] = new Chart(ctx, { type, data, options: { responsive: true, ...options } });
        }
        
        function generateAndShowInvoice(orderId) {
            const order = caches.orders.find(o => o.id === orderId);
            if (!order) return;
            const tableName = tableMap.get(order.table_id)?.name || 'N/A';
            const orderIdDisplay = `${tableName.replace(' ','-')}-${order.id.substring(0,6)}`;
            const invoiceContent = document.getElementById('invoiceContent');
            const currency = restaurantSettings.currency_symbol || 'â‚¹';

            invoiceContent.dataset.orderId = orderIdDisplay;
            
            invoiceContent.innerHTML = `
                <div class="space-y-6">
                    <!-- Header: Company Info and Title -->
                    <div class="flex justify-between items-start border-b pb-4">
                        <div>
                            <img src="${restaurantSettings.logo_url || 'https://placehold.co/150x50/1F2937/FFFFFF?text=Logo'}" onerror="this.onerror=null;this.src='https://placehold.co/150x50/1F2937/FFFFFF?text=Logo';" alt="Logo" class="h-10 mb-2">
                            <h1 class="text-2xl font-bold editable-text" contenteditable="true">${htmlEscape(restaurantSettings.name)}</h1>
                            <p class="text-xs text-gray-600 editable-text" contenteditable="true">${htmlEscape(restaurantSettings.address)}</p>
                            <p class="text-xs text-gray-600">GSTIN: <span class="editable-text" contenteditable="true">${htmlEscape(restaurantSettings.gst_number)}</span></p>
                        </div>
                        <div class="text-right">
                            <h2 class="text-3xl font-extrabold text-blue-600">INVOICE</h2>
                            <p class="text-sm mt-1">Order Date: <span class="editable-text" contenteditable="true">${new Date(order.created_at).toLocaleDateString()}</span></p>
                            <p class="text-sm">Invoice No: <span class="font-mono editable-text" contenteditable="true">${orderIdDisplay}</span></p>
                        </div>
                    </div>

                    <!-- Customer/Table Info -->
                    <div class="flex justify-between text-sm">
                        <div>
                            <p class="font-semibold">Billed To:</p>
                            <p>Table: <span class="font-bold editable-text" contenteditable="true">${htmlEscape(tableName)}</span></p>
                            <p>Order Status: ${order.status}</p>
                        </div>
                        <div>
                             <p class="font-semibold">Payment Status:</p>
                             <p class="font-bold text-green-600 editable-text" contenteditable="true">${order.payment_status}</p>
                        </div>
                    </div>

                    <!-- Line Items Table -->
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-100 text-sm font-semibold border-b">
                                <th class="p-3">Item</th>
                                <th class="p-3 text-right w-16">Qty</th>
                                <th class="p-3 text-right w-20">Price</th>
                                <th class="p-3 text-right w-24">Total</th>
                            </tr>
                        </thead>
                        <tbody>${order.order_details.items.map(i => `
                            <tr class="text-sm border-b hover:bg-gray-50">
                                <td class="p-3 editable-text" contenteditable="true">${htmlEscape(i.name)}</td>
                                <td class="p-3 text-right editable-text" contenteditable="true">${i.quantity}</td>
                                <td class="p-3 text-right">${i.price.toFixed(2)}</td>
                                <td class="p-3 text-right font-medium">${(i.price * i.quantity).toFixed(2)}</td>
                            </tr>`).join('')}
                        </tbody>
                    </table>

                    <!-- Totals and Tax Breakdown -->
                    <div class="flex justify-end">
                        <div class="w-full max-w-xs space-y-1 text-sm">
                            <div class="flex justify-between font-medium">
                                <p>Subtotal:</p>
                                <p>${currency}<span class="editable-text" contenteditable="true">${order.order_details.subtotal.toFixed(2)}</span></p>
                            </div>
                            
                            <!-- Tax Breakdown -->
                            ${(order.order_details.taxes || []).map(t => `
                            <div class="flex justify-between text-orange-600 font-medium">
                                <p>${htmlEscape(t.name)} (${t.rate_percent}%):</p>
                                <p>${currency}<span class="editable-text" contenteditable="true">${t.amount.toFixed(2)}</span></p>
                            </div>`).join('')}

                            <div class="flex justify-between font-extrabold text-lg pt-2 border-t-2 border-gray-900">
                                <p>GRAND TOTAL:</p>
                                <p>${currency}<span class="editable-text" contenteditable="true">${order.order_details.total.toFixed(2)}</span></p>
                            </div>
                        </div>
                    </div>
                </div>`;
            document.getElementById('invoiceModal').classList.add('active');
            lucide.createIcons(); // Ensure icons in the modal buttons work immediately
        }

        // --- ACTION HANDLERS ---
        // Moved up for better function declaration flow

        const handleFileUpload = async (file, bucket = 'general-uploads') => {
            if (!file) return { data: null, error: null };
            
            // Random file name generation
            const fileExtension = file.name.split('.').pop();
            const fileName = `${crypto.randomUUID()}.${fileExtension}`;
            const filePath = `${fileName}`;

            const { error: uploadError } = await supabaseClient.storage.from(bucket).upload(filePath, file);
            if (uploadError) { 
                showToast(`Upload failed: ${uploadError.message}`, true); 
                return { data: null, error: uploadError }; 
            }
            const { data } = supabaseClient.storage.from(bucket).getPublicUrl(filePath);
            return { data: { publicUrl: data.publicUrl, path: filePath }, error: null };
        };

        async function handleSlideshowUpload() {
            const imageFile = document.getElementById('slideshowImageInput').files[0];
            if (!imageFile) return showToast('Please select an image file.', true);
            
            if (imageFile.size > 2 * 1024 * 1024) return showToast('File size must be â‰¤ 2MB.', true);
            if (!['image/png', 'image/jpeg', 'image/webp'].includes(imageFile.type)) return showToast('Only PNG, JPG, or WEBP images are allowed.', true);

            const { data, error } = await handleFileUpload(imageFile, 'slideshow-images'); // Separate bucket
            if (error) return;
            const { error: dbError } = await supabaseClient.from('slideshow_images').insert({ image_url: data.publicUrl });
            if (dbError) return showToast('Failed to save image reference.', true);
            
            // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
            setTimeout(() => {
                showToast('Image uploaded!');
                document.getElementById('slideshowModal').classList.remove('active');
                document.getElementById('slideshowImageInput').value = '';
                logActivity('Uploaded slideshow image');
            }, 0);
        }

        async function handleDeleteSlideshow(btn) {
            const id = btn.dataset.id;
            const url = btn.dataset.url;
            // Assuming the image path is at the end of the URL after the last slash
            const path = url.substring(url.lastIndexOf('/') + 1);

            promptForDelete('Delete this slideshow image?', async () => {
                const { error: dbError } = await supabaseClient.from('slideshow_images').delete().eq('id', id);
                if (dbError) return showToast('Failed to delete database record.', true);
                
                // Attempt to delete storage file, non-critical if it fails
                const storagePath = `public/${path}`; // Assuming the folder structure
                await supabaseClient.storage.from('slideshow-images').remove([storagePath]);

                // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                setTimeout(() => {
                    showToast('Slideshow image deleted.'); 
                    logActivity('Deleted slideshow image');
                }, 0);
            });
        }
        
        function openOfferModal(offerId = null) {
            const offer = offerId ? caches.offers.find(o => o.id === offerId) : null;
            document.getElementById('offerModalTitle').textContent = offer ? 'Edit Offer' : 'Add New Offer';
            document.getElementById('offerId').value = offer?.id || '';
            document.getElementById('offerTitleInput').value = offer?.title || '';
            document.getElementById('offerDescInput').value = offer?.description || '';
            document.getElementById('offerImageInput').value = '';
            const preview = document.getElementById('offerImagePreview');
            preview.src = offer?.image_url || '';
            preview.classList.toggle('hidden', !offer?.image_url);
            document.getElementById('offerModal').classList.add('active');
        }
        
        async function handleSaveOffer() {
            const id = document.getElementById('offerId').value;
            const title = document.getElementById('offerTitleInput').value;
            if(!title) return showToast('Offer title is required.', true);
            
            let offer = caches.offers.find(o => o.id === id);
            let image_url = offer?.image_url || null;
            const imageFile = document.getElementById('offerImageInput').files[0];
            
            if (imageFile) {
                if (imageFile.size > 2 * 1024 * 1024) return showToast('File size must be â‰¤ 2MB.', true);
                if (!['image/png', 'image/jpeg', 'image/webp'].includes(imageFile.type)) return showToast('Only PNG, JPG, or WEBP images are allowed.', true);

                const { data, error } = await handleFileUpload(imageFile, 'offer-images');
                if (error) return;
                image_url = data.publicUrl;
            }

            const offerData = { title, description: document.getElementById('offerDescInput').value, image_url };
            const { error } = id ? await supabaseClient.from('offers').update(offerData).eq('id', id) : await supabaseClient.from('offers').insert(offerData);
            
            if (error) return showToast(`Error saving offer: ${error.message}`, true);
            
            // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
            setTimeout(() => {
                showToast(`Offer ${id ? 'updated' : 'created'}!`);
                document.getElementById('offerModal').classList.remove('active');
                logActivity(`${id ? 'Updated' : 'Created'} offer: ${title}`);
            }, 0);
        }

        async function handleDeleteOffer(btn) {
            const id = btn.dataset.id;
            promptForDelete('Delete this offer?', async () => {
                const { error } = await supabaseClient.from('offers').delete().eq('id', id);
                if (error) return showToast('Failed to delete offer.', true);
                
                // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                setTimeout(() => {
                    showToast('Offer deleted.'); 
                    logActivity(`Deleted offer ID ${id}`);
                }, 0);
            });
        }
        
        async function handleOfferToggle(toggle) {
            const id = toggle.dataset.id;
            const is_active = toggle.checked;
            const { error } = await supabaseClient.from('offers').update({ is_active }).eq('id', id);
            if (error) { showToast('Error updating offer status.', true); } else {
                // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                setTimeout(() => {
                    logActivity(`Set offer ${id} active status to ${is_active}`);
                }, 0);
            }
        }
        
        // --- EVENT LISTENER SETUP FUNCTIONS ---
        // Moved up for robust execution order.

        function setupInvoiceListeners() {
            document.getElementById('downloadPdfBtn').addEventListener('click', async () => {
                const modalBody = document.querySelector('#invoiceModal > div');
                const invoiceContent = document.getElementById('invoiceContent');
                const orderId = invoiceContent.dataset.orderId || 'invoice';
                
                // Hide buttons and dashed lines for capture
                modalBody.classList.add('printing-invoice');
                
                showToast('Generating PDF...');
                
                // Use html2canvas to capture the content
                const canvas = await html2canvas(invoiceContent, {
                    scale: 2, // Higher scale for better quality
                    useCORS: true,
                    allowTaint: true
                });

                // Restore hidden elements
                modalBody.classList.remove('printing-invoice');

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; 
                const pageHeight = 295; 
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }

                pdf.save(`${orderId}.pdf`);
                showToast('PDF downloaded successfully!');
                logActivity(`Downloaded PDF for order ${orderId}`);
            });

            document.getElementById('printInvoiceBtn').addEventListener('click', () => {
                logActivity(`Printing invoice`);
                // Use a class on the body to control print styles
                document.body.classList.add('printing-invoice');
                window.print();
            });
             window.addEventListener('afterprint', () => document.body.classList.remove('printing-invoice'));
        }
        
        function setupMenuListeners() {
             document.getElementById('addCategoryBtn').addEventListener('click', () => {
                document.getElementById('categoryId').value = '';
                document.getElementById('categoryNameInput').value = '';
                document.getElementById('categoryModal').classList.add('active');
            });
            document.getElementById('saveCategoryBtn').addEventListener('click', async () => {
                const id = document.getElementById('categoryId').value;
                const name = document.getElementById('categoryNameInput').value;
                if (!name) return showToast('Category name is required.', true);
                const { error } = id ? await supabaseClient.from('categories').update({ name }).eq('id', id) : await supabaseClient.from('categories').insert({ name });
                if (error) { showToast('Error saving category.', true); } else {
                    // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                    setTimeout(() => {
                        showToast(`Category ${id ? 'updated' : 'added'}!`);
                        document.getElementById('categoryModal').classList.remove('active');
                        logActivity(`${id ? 'Updated' : 'Created'} category: ${name}`);
                    }, 0);
                }
            });

            const menuContainer = document.getElementById('menuContainer');
            menuContainer.addEventListener('click', async e => {
                const editBtn = e.target.closest('.edit-category-btn');
                const deleteBtn = e.target.closest('.delete-category-btn');
                const addBtn = e.target.closest('.add-item-btn');
                const editItemBtn = e.target.closest('.edit-item-btn');
                const deleteItemBtn = e.target.closest('.delete-item-btn');

                if (editBtn) {
                    document.getElementById('categoryId').value = editBtn.dataset.id;
                    document.getElementById('categoryNameInput').value = editBtn.dataset.name;
                    document.getElementById('categoryModal').classList.add('active');
                }
                if (deleteBtn) {
                    promptForDelete('Delete this category and all its items?', async () => {
                        const { error } = await supabaseClient.from('categories').delete().eq('id', deleteBtn.dataset.id);
                        if(error) showToast('Error deleting category.', true); 
                        else { 
                            // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                            setTimeout(() => {
                                showToast('Category deleted.'); 
                                logActivity(`Deleted category ID ${deleteBtn.dataset.id}`);
                            }, 0);
                        }
                    });
                }
                if(addBtn) {
                    document.getElementById('itemId').value = ''; document.getElementById('itemCategoryId').value = addBtn.dataset.categoryId;
                    document.getElementById('itemNameInput').value = ''; document.getElementById('itemDescInput').value = ''; document.getElementById('itemPriceInput').value = ''; document.getElementById('itemImageInput').value = '';
                    document.getElementById('itemImagePreview').classList.add('hidden'); document.getElementById('itemModalTitle').textContent = 'Add New Item';
                    document.getElementById('itemModal').classList.add('active');
                }
                 if(editItemBtn) {
                    const itemId = editItemBtn.dataset.id;
                    const item = itemMap.get(itemId);
                    if (!item) return showToast('Item not found in cache.', true);

                    document.getElementById('itemId').value = item.id; document.getElementById('itemCategoryId').value = item.category_id;
                    document.getElementById('itemNameInput').value = item.name; document.getElementById('itemDescInput').value = item.description; document.getElementById('itemPriceInput').value = item.price;
                    document.getElementById('itemImageInput').value = ''; 
                    const preview = document.getElementById('itemImagePreview');
                    if(item.image_url) { preview.src = item.image_url; preview.classList.remove('hidden'); } else { preview.classList.add('hidden'); }
                    document.getElementById('itemModalTitle').textContent = 'Edit Item';
                    document.getElementById('itemModal').classList.add('active');
                }
                if(deleteItemBtn) {
                    const itemId = deleteItemBtn.dataset.id;
                    promptForDelete('Delete this menu item?', async () => {
                        const { error } = await supabaseClient.from('items').delete().eq('id', itemId);
                        if(error) showToast('Error deleting item.', true); 
                        else { 
                            // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                            setTimeout(() => {
                                showToast('Item deleted.'); 
                                logActivity(`Deleted item ID ${itemId}`);
                            }, 0);
                        }
                    });
                }
            });
            menuContainer.addEventListener('change', async e => {
                if (e.target.classList.contains('item-availability-toggle')) {
                    const id = e.target.dataset.id; const is_available = e.target.checked;
                    const { error } = await supabaseClient.from('items').update({ is_available }).eq('id', id); 
                    if (error) { showToast('Error updating item availability.', true); } else {
                        // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                        setTimeout(() => {
                            logActivity(`Set item ${id} availability to ${is_available}`);
                        }, 0);
                    }
                }
            });
            document.getElementById('saveItemBtn').addEventListener('click', async () => {
                const id = document.getElementById('itemId').value; 
                const category_id = document.getElementById('itemCategoryId').value;
                const name = document.getElementById('itemNameInput').value; 
                const description = document.getElementById('itemDescInput').value;
                const price = parseFloat(document.getElementById('itemPriceInput').value); 
                const imageFile = document.getElementById('itemImageInput').files[0];

                if (!name || isNaN(price)) return showToast('Item name and a valid price are required.', true);
                
                let image_url = itemMap.get(id)?.image_url || null;

                if (imageFile) {
                    if (imageFile.size > 2 * 1024 * 1024) return showToast('File size must be â‰¤ 2MB.', true);
                    if (!['image/png', 'image/jpeg', 'image/webp'].includes(imageFile.type)) return showToast('Only PNG, JPG, or WEBP images are allowed.', true);
                    
                    const { data, error } = await handleFileUpload(imageFile, 'item-images');
                    if (error) return;
                    image_url = data.publicUrl;
                }

                const itemData = { name, description, price, category_id, image_url };
                const { error } = id ? await supabaseClient.from('items').update(itemData).eq('id', id) : await supabaseClient.from('items').insert(itemData);
                
                if (error) { showToast(`Error saving item: ${error.message}`, true); } else {
                    // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                    setTimeout(() => {
                        showToast(`Item ${id ? 'updated' : 'added'}!`); 
                        document.getElementById('itemModal').classList.remove('active');
                        logActivity(`${id ? 'Updated' : 'Created'} item: ${name}`);
                    }, 0);
                }
            });
        }

        function setupTableListeners() {
            document.getElementById('addTableBtn').addEventListener('click', () => {
                document.getElementById('tableId').value = ''; document.getElementById('tableNameInput').value = '';
                document.getElementById('tableModal').classList.add('active');
            });
            document.getElementById('saveTableBtn').addEventListener('click', async () => {
                const name = document.getElementById('tableNameInput').value; if(!name) return showToast('Table name is required.', true);
                const { error } = await supabaseClient.from('tables').insert({ name });
                if(error) {
                    showToast('Error saving table: ' + error.message, true); 
                } else { 
                    // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                    setTimeout(() => {
                        showToast('Table added!'); 
                        document.getElementById('tableModal').classList.remove('active'); 
                        logActivity(`Added table: ${name}`);
                    }, 0);
                }
            });
            
            // CRITICAL FIX: Delegating table actions to the container
            document.getElementById('tablesContainer').addEventListener('click', async e => {
                 const qrBtn = e.target.closest('.show-qr-btn'); 
                 const deleteBtn = e.target.closest('.delete-table-btn');

                 if(qrBtn) {
                    try {
                        const tableId = qrBtn.dataset.id; const tableName = qrBtn.dataset.name; const qrContainer = document.getElementById('qrcode');
                        
                        // Clear previous QR and show loading state
                        qrContainer.innerHTML = `<div class="p-4"><svg class="animate-spin h-8 w-8 text-yellow-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>`;
                        
                        // Generate QR Code with small timeout to ensure UI updates instantly
                        setTimeout(() => {
                            qrContainer.innerHTML = ''; // Clear loading state
                            new QRCode(qrContainer, { text: `https://namoclient.netlify.app/?table_id=${tableId}`, width: 256, height: 256 });
                            document.getElementById('qrModalTitle').textContent = `QR Code for ${tableName}`;
                            document.getElementById('downloadQRBtn').dataset.tableName = tableName;
                            document.getElementById('qrModal').classList.add('active');
                        }, 10); // Very small delay is enough to unblock the main thread
                    } catch (e) {
                        console.error("QR Code generation error:", e);
                        showToast("Failed to generate QR code.", true);
                    }
                 }

                 if(deleteBtn) {
                    const tableIdToDelete = deleteBtn.dataset.id;
                    const table = tableMap.get(tableIdToDelete);
                    const tableName = table ? table.name : 'this table';

                    promptForDelete(`Delete table "${tableName}"? This will unlink it from past orders but won't delete the order history itself.`, async () => {
                        // Unlink orders first
                        await supabaseClient
                            .from('orders')
                            .update({ table_id: null })
                            .eq('table_id', tableIdToDelete);

                        const { error: deleteError } = await supabaseClient
                            .from('tables')
                            .delete()
                            .eq('id', tableIdToDelete);

                        if (deleteError) {
                            showToast('Error deleting table.', true);
                        } else {
                             // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                            setTimeout(() => {
                                showToast('Table deleted successfully.');
                                logActivity(`Deleted table ID ${tableIdToDelete}`);
                            }, 0);
                        }
                    });
                 }
            });
             document.getElementById('downloadQRBtn').addEventListener('click', e => {
                const qrCanvas = document.querySelector('#qrcode canvas');
                if (qrCanvas) {
                    const link = document.createElement('a');
                    link.download = `${e.target.dataset.tableName}-qr-code.png`;
                    link.href = qrCanvas.toDataURL('image/png');
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                }
            });
        }

        function setupOrderListeners() {
             document.getElementById('liveOrdersContainer').addEventListener('click', async e => {
                const statusBtn = e.target.closest('.update-order-status-btn');
                if(statusBtn) {
                    const orderId = statusBtn.dataset.id; 
                    const newStatus = statusBtn.dataset.status;
                    
                    // Show loading state immediately on the clicked button
                    const originalText = statusBtn.innerHTML;
                    statusBtn.disabled = true;
                    statusBtn.innerHTML = `<svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
                    
                    const updateData = { status: newStatus };
                    if (newStatus === 'completed') { updateData.closed_at = new Date().toISOString(); updateData.payment_status = 'paid'; }
                    
                    const { error } = await supabaseClient.from('orders').update(updateData).eq('id', orderId);
                    
                    if(error) { 
                        showToast('Error updating status.', true); 
                        // Restore button state on error
                        statusBtn.innerHTML = originalText;
                        statusBtn.disabled = false;
                    } else {
                         // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                        setTimeout(() => {
                            showToast(`Order status changed to ${newStatus}`);
                            logActivity(`Updated order ${orderId} to ${newStatus}`);
                            if (newStatus === 'completed') generateAndShowInvoice(orderId);
                        }, 0);
                        // The REAL-TIME LISTENER will handle the visual update and clear the spinner on render.
                    }
                }
            });
             document.getElementById('historyContainer').addEventListener('click', async e => {
                const invoiceBtn = e.target.closest('.generate-invoice-btn');
                const deleteBtn = e.target.closest('.delete-order-btn');
                if(invoiceBtn) generateAndShowInvoice(invoiceBtn.dataset.orderId);
                if(deleteBtn) {
                    const orderId = deleteBtn.dataset.orderId;
                    promptForDelete('Delete this order from history?', async () => {
                        const { error } = await supabaseClient.from('orders').delete().eq('id', orderId);
                        if (error) showToast('Error deleting order.', true); 
                        else { 
                            // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                            setTimeout(() => {
                                showToast('Order deleted.'); 
                                logActivity(`Deleted order ID ${orderId}`);
                            }, 0);
                        }
                    });
                }
            });
        }

        function setupCrudListeners(page, tableName, modalId, addBtnId, saveBtnId, inputIds, dbFields) {
            const container = document.getElementById(page === 'tax' ? 'taxesContainer' : `${page}sContainer`);
            
            // Check if the add button exists before adding listener
            const addBtn = document.getElementById(addBtnId);
            if (addBtn) {
                 addBtn.addEventListener('click', () => {
                    document.getElementById(`${page}Id`).value = '';
                    inputIds.forEach(id => document.getElementById(id).value = '');
                    document.getElementById(modalId).classList.add('active');
                    lucide.createIcons(); // Icons in modal
                });
            }

            container.addEventListener('click', async e => {
                const editBtn = e.target.closest(`.edit-${page}-btn`);
                const deleteBtn = e.target.closest(`.delete-${page}-btn`);
                if (editBtn) {
                    document.getElementById(`${page}Id`).value = editBtn.dataset.id;
                    inputIds.forEach((inputId, i) => {
                        document.getElementById(inputId).value = editBtn.dataset[dbFields[i]];
                    });
                    document.getElementById(modalId).classList.add('active');
                    lucide.createIcons(); // Icons in modal
                }
                if (deleteBtn) {
                     promptForDelete(`Delete this ${page}?`, async () => {
                        const { error } = await supabaseClient.from(tableName).delete().eq('id', deleteBtn.dataset.id);
                        if (error) showToast(`Error deleting ${page}.`, true);
                        else { 
                             // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                            setTimeout(() => {
                                showToast(`${page} deleted.`); 
                                logActivity(`Deleted ${page} ID ${deleteBtn.dataset.id}`);
                            }, 0);
                        }
                    });
                }
            });

            const saveBtn = document.getElementById(saveBtnId);
            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    const id = document.getElementById(`${page}Id`).value;
                    const record = {};
                    inputIds.forEach((inputId, i) => {
                        record[dbFields[i]] = document.getElementById(inputId).value;
                    });
                    const { error } = id ? await supabaseClient.from(tableName).update(record).eq('id', id) : await supabaseClient.from(tableName).insert(record);
                    if (error) showToast(`Error saving ${page}: ${error.message}`, true);
                    else { 
                         // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                        setTimeout(() => {
                            showToast(`${page} saved!`); 
                            document.getElementById(modalId).classList.remove('active'); 
                            logActivity(`${id ? 'Updated' : 'Created'} ${page}`);
                        }, 0);
                    }
                });
            }

            const toggleContainer = document.getElementById(page === 'tax' ? 'taxesContainer' : `${page}sContainer`);
            toggleContainer.addEventListener('change', async e => {
                 if(e.target.type === 'checkbox') {
                     const id = e.target.dataset.id;
                     const isEnabled = e.target.checked;
                     const columnName = page === 'tax' ? 'is_enabled' : 'is_active';
                     const { error } = await supabaseClient.from(tableName).update({ [columnName]: isEnabled }).eq('id', id);
                     if (error) { showToast(`Error updating ${page} status.`, true); } else {
                         // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                        setTimeout(() => {
                            logActivity(`Set ${tableName} ${id} ${columnName} to ${isEnabled}`);
                        }, 0);
                     }
                 }
            });
        }
        
        function setupSlideshowListeners() {
            const addBtn = document.getElementById('addSlideshowImageBtn');
            const saveBtn = document.getElementById('saveSlideshowImageBtn');
            const container = document.getElementById('slideshowContainer');

            if (addBtn) addBtn.addEventListener('click', () => { document.getElementById('slideshowModal').classList.add('active'); lucide.createIcons(); });
            if (saveBtn) saveBtn.addEventListener('click', handleSlideshowUpload);
            
            container.addEventListener('click', async e => {
                if (e.target.closest('.delete-slideshow-btn')) await handleDeleteSlideshow(e.target.closest('.delete-slideshow-btn'));
            });
        }

        function setupOfferListeners() {
            const addBtn = document.getElementById('addOfferBtn');
            const saveBtn = document.getElementById('saveOfferBtn');
            const container = document.getElementById('offersContainer');

            if (addBtn) addBtn.addEventListener('click', () => { openOfferModal(); lucide.createIcons(); });
            if (saveBtn) saveBtn.addEventListener('click', handleSaveOffer);

            // CRITICAL FIX: Delegating offer actions to the container
            container.addEventListener('click', async e => {
                const editBtn = e.target.closest('.edit-offer-btn');
                const deleteBtn = e.target.closest('.delete-offer-btn');
                if(editBtn) { openOfferModal(editBtn.dataset.id); lucide.createIcons(); }
                if(deleteBtn) await handleDeleteOffer(deleteBtn);
            });
            
            container.addEventListener('change', async e => {
                if(e.target.classList.contains('offer-active-toggle')) await handleOfferToggle(e.target);
            });
        }
        
        function setupSettingsListeners() {
            const saveBtn = document.getElementById('saveSettingsBtn');
            const deleteAllBtn = document.getElementById('deleteAllOrdersBtn');
            const downloadBtn = document.getElementById('downloadDataBtn');

            if (saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    const updates = { 
                        user_email: currentUser.email, // Use email as unique identifier
                        name: document.getElementById('restaurantName').value, 
                        currency_symbol: document.getElementById('restaurantCurrency').value, 
                        logo_url: document.getElementById('logoUrl').value, 
                        welcome_message: document.getElementById('welcomeMessage').value, 
                        google_business_url: document.getElementById('googleBusinessLink').value,
                        address: document.getElementById('restaurantAddress').value,
                        gst_number: document.getElementById('restaurantGST').value
                    };
                    
                    const { error } = await supabaseClient.from('settings').upsert(updates, { onConflict: 'user_email' });
                    if (error) showToast('Error saving settings.', true);
                    else { 
                        // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                        setTimeout(() => {
                            showToast('Settings saved successfully!'); 
                            logActivity('Updated restaurant settings');
                        }, 0);
                    }
                });
            }

            if (deleteAllBtn) {
                deleteAllBtn.addEventListener('click', () => {
                    promptForDelete('This will delete ALL order history permanently. Type DELETE to confirm.', async () => {
                        const { error } = await supabaseClient.from('orders').delete().neq('status', 'non-existent-status'); // Deletes all rows
                        if (error) showToast('Error deleting order history.', true);
                        else { 
                             // CRITICAL FIX: Use setTimeout(0) to ensure the UI updates instantly
                            setTimeout(() => {
                                showToast('All order history has been deleted.'); 
                                logActivity('Deleted all order history');
                            }, 0);
                        }
                    }, true); // The 'true' flag requires confirmation text
                });
            }

            if (downloadBtn) {
                 downloadBtn.addEventListener('click', async () => {
                    showToast('Preparing data...');
                    const { data: orders, error: orderError } = await supabaseClient.from('orders').select('*');
                    const { data: activity_logs, error: logError } = await supabaseClient.from('activity_logs').select('*');
                    if(orderError || logError) return showToast('Could not fetch data for download.', true);
                    const dataToDownload = { restaurant_name: restaurantSettings.name || 'Export', export_date: new Date().toISOString(), orders, activity_logs };
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToDownload, null, 2));
                    const a = document.createElement('a');
                    a.setAttribute("href", dataStr);
                    a.setAttribute("download", `${restaurantSettings.name}_export_${new Date().toISOString().split('T')[0]}.json`);
                    document.body.appendChild(a); a.click(); a.remove();
                    showToast('Download started!'); logActivity('Downloaded all data');
                });
            }
        }

        // --- MAIN EVENT LISTENER INITIALIZER ---
        function setupEventListeners() {
            // Navigation Listener
            document.getElementById('mainNav').addEventListener('click', (e) => {
                if (e.target.tagName === 'A' || e.target.closest('a')) {
                    e.preventDefault();
                    const link = e.target.closest('a');
                    const targetId = link.getAttribute('href').substring(1);
                    document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
                    document.getElementById(targetId)?.classList.remove('hidden');
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    window.location.hash = targetId;
                    if (targetId === 'analytics') renderAnalytics(); // Ensure charts update on view
                }
            });

            // Handle initial page load hash
            const currentHash = window.location.hash.substring(1) || 'dashboard';
            document.querySelector(`.nav-link[href="#${currentHash}"]`)?.click();

            // Modal Close Listeners
            document.querySelectorAll('.modal-cancel').forEach(btn => btn.addEventListener('click', () => btn.closest('.modal').classList.remove('active')));
            
            // Global Delete Confirmation Logic
            let deleteAction = null;
            let isDeleteAll = false;
            const confirmDeleteModal = document.getElementById('confirmDeleteModal');
            const confirmInput = document.getElementById('confirmDeleteInput');

            window.promptForDelete = (message, action, needsConfirmation = false) => {
                document.getElementById('confirmDeleteText').textContent = message;
                deleteAction = action;
                isDeleteAll = needsConfirmation;
                confirmInput.classList.toggle('hidden', !needsConfirmation);
                confirmInput.value = '';
                confirmDeleteModal.classList.add('active');
                document.getElementById('confirmDeleteBtn').disabled = needsConfirmation; // Disable if confirmation text is needed
            };
            
            // Enable button only if confirmation text matches "DELETE"
            confirmInput.addEventListener('input', () => {
                document.getElementById('confirmDeleteBtn').disabled = isDeleteAll && confirmInput.value !== 'DELETE';
            });

            document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
                if (isDeleteAll && confirmInput.value !== 'DELETE') return; 

                // Add a small loading spinner to the button
                const btn = document.getElementById('confirmDeleteBtn');
                const originalText = btn.textContent;
                btn.innerHTML = `<svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Deleting...`;
                btn.disabled = true;

                if (typeof deleteAction === 'function') await deleteAction();

                // Restore button state
                btn.textContent = originalText;
                btn.disabled = false;
                confirmDeleteModal.classList.remove('active');
            });
            
            // Calling all setup functions:
            try {
                setupMenuListeners();
                setupTableListeners();
                setupOrderListeners();
                setupCrudListeners('tax', 'taxes', 'taxModal', 'addTaxBtn', 'saveTaxBtn', ['taxNameInput', 'taxRateInput'], ['name', 'rate_percent']);
                setupCrudListeners('promo', 'promotions', 'promoModal', 'addPromoBtn', 'savePromoBtn', ['promoCodeInput', 'promoDiscountInput'], ['code', 'discount_percent']);
                setupSlideshowListeners();
                setupOfferListeners();
                setupSettingsListeners();
                setupInvoiceListeners();
            } catch (error) {
                // This catch block is the final safety net for listener attachment
                console.error("Critical error setting up event listeners. UI will be unresponsive:", error);
                showToast("Application failed to initialize. Check console for critical errors.", true);
            }
        }

        // --- Final Check ---
        if (!supabaseUrl.includes('supabase.co') || !supabaseKey.startsWith('ey')) {
            showToast('Supabase credentials are not set correctly! Please update the supabaseUrl and supabaseKey.', true);
        } else {
            checkSession();
        }
    </script>
</body>
</html>
